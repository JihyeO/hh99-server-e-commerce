# 주문 서비스 MSA 전환을 위한 설계

## 목적

기존 모놀리식 주문 서비스 구조를 MSA 아키텍처에 적합하게 재구성하여, 서비스 간 **결합도를 낮추고**, **확장성**과 **장애 격리성**을 확보한다.

## 기존 구조 (Monolithic)

### 흐름

1. 상품 목록 조회 및 재고 확인
2. 잔액 조회 및 차감
3. 재고 차감
4. 주문 저장
5. 주문 생성 이벤트 발행

### 특징

1. 모든 로직이 동기적으로 하나의 트랜잭션 안에서 처리됨
2. 강한 일관성 보장
3. 서비스 간 강한 결합
4. 장애 전파 가능성 높음

## 제안 구조 (MSA + Event-driven)

### 핵심 흐름

1. **주문 서비스**

   - 사용자의 주문 요청을 수신
   - 주문 도메인 객체 생성 및 저장
   - `OrderCreatedEvent` 이벤트 발행 (Kafka 등 메시지 브로커를 통해)

2. **잔액 서비스**

   - `OrderCreatedEvent` 수신
   - 사용자 잔액 확인 및 차감
   - 처리 결과에 따라 `BalanceDeductedEvent` 발행

3. **재고 서비스**

   - `OrderCreatedEvent` 수신
   - 상품 재고 확인 및 차감
   - 처리 결과에 따라 `StockDeductedEvent` 발행

4. **주문 서비스 또는 Saga Coordinator**
   - `BalanceDeductedEvent`, `StockDeductedEvent` 수신
   - 모든 처리 성공 시 주문 상태를 "완료"로 변경
   - 실패 시 주문 취소 및 보상 트랜잭션 수행

### 구조

- 주문 서비스는 주문 생성과 이벤트 발행만 책임짐
- 각 도메인 서비스는 이벤트를 수신하고 개별 로직을 처리
- 비동기 이벤트 기반으로 작동하며, 최종 일관성을 보장
- 실패 시 보상 트랜잭션(Saga)을 통해 롤백 처리

## 서비스별 책임

| 서비스             | 책임                                            | 비고                                             |
| ------------------ | ----------------------------------------------- | ------------------------------------------------ |
| 주문 서비스        | 주문 생성, `OrderCreatedEvent` 발행             | DB 저장 후 이벤트 발행                           |
| 잔액 서비스        | 사용자 잔액 확인 및 차감                        | 이벤트 수신 → 처리 → `BalanceDeductedEvent` 발행 |
| 재고 서비스        | 재고 확인 및 차감                               | 이벤트 수신 → 처리 → `StockDeductedEvent` 발행   |
| Order Orchestrator | 잔액/재고 이벤트 확인 후 주문 확정 or 취소 처리 | 분산 트랜잭션의 조정자 역할                      |
